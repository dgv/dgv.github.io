<!doctype html><html lang=en><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><style>:root{--accent-color:#8fbcbb;--font-size:17.5px}</style><title>sqlite over s3</title><meta name=description content="We love boring technology, sqlite is everywere, solid stunning performace and features, but it was developed to be embeded to the app without a management …"><meta name=keywords content='blog,devlog,golang,zig,openbsd,web3'><meta property="og:url" content="http://localhost:1313/posts/2024-11-10-sqlite-over-s3/"><meta property="og:type" content="website"><meta property="og:title" content="sqlite over s3"><meta property="og:description" content="We love boring technology, sqlite is everywere, solid stunning performace and features, but it was developed to be embeded to the app without a management …"><meta property="og:image" content="http://localhost:1313/img/dgv_dev_br.png"><meta property="og:image:secure_url" content="http://localhost:1313/img/dgv_dev_br.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="sqlite over s3"><meta name=twitter:description content="We love boring technology, sqlite is everywere, solid stunning performace and features, but it was developed to be embeded to the app without a management …"><meta property="twitter:domain" content="http://localhost:1313/posts/2024-11-10-sqlite-over-s3/"><meta property="twitter:url" content="http://localhost:1313/posts/2024-11-10-sqlite-over-s3/"><meta name=twitter:image content="http://localhost:1313/img/dgv_dev_br.png"><link rel=canonical href=http://localhost:1313/posts/2024-11-10-sqlite-over-s3/><link rel=stylesheet type=text/css href=/css/normalize.min.css media=print><link rel=stylesheet type=text/css href=/css/main.min.css><link id=dark-theme rel=stylesheet href=/css/dark.min.css><script src=/js/bundle.min.70293498aa96b2dbb767ec11a622eb2266d8fc37a0fff88233a82952e3c72b15.js integrity="sha256-cCk0mKqWstu3Z+wRpiLrImbY/Deg//iCM6gpUuPHKxU="></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.22/dist/katex.min.css integrity=sha384-5TcZemv2l/9On385z///+d7MSYlvIEw9FuZTIdZ14vJLqWphw7e7ZPuOiCHJcFCP crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.22/dist/katex.min.js integrity=sha384-cMkvdD8LoxVzGF/RPUKAcvmm49FQ0oxwDF3BGKtDXcEc+T1b2N+teh/OJfpU0jr6 crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.22/dist/contrib/auto-render.min.js integrity=sha384-hCXGrW6PitJEwbkoStFjeJxv+fSOOQKOPbJxSfM6G5sWZjAyWhXiTIIAmQqnlLlh crossorigin=anonymous></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],throwOnError:!1})})</script></head><body><script>setThemeByUserPref()</script><header class=header><nav class=header-nav><div class=avatar><a href=http://localhost:1313/><img src=/img/dgv_dev_br.png alt=avatar></a></div><div class=nav-title><a class=nav-brand href=http://localhost:1313/>dgv</a></div><div class=nav-links><div class=nav-link><a href=http://localhost:1313/ aria-label><span data-feather=home></span> Home</a></div><div class=nav-link><a href=http://localhost:1313/posts/ aria-label><span data-feather=book></span> Posts</a></div><div class=nav-link><a href=http://localhost:1313/projects/ aria-label><span data-feather=code></span> Projects</a></div><div class=nav-link><a href=http://localhost:1313/tags/ aria-label><span data-feather=tag></span> Tags</a></div><div class=nav-link><a href=http://localhost:1313/tips/ aria-label><span data-feather=info></span> Tips</a></div><div class=nav-link><a href=https://github.com/dgv aria-label=github><span data-feather=github></span></a></div><div class=nav-link><a href=http://localhost:1313/index.xml aria-label=rss><span data-feather=rss></span></a></div><span class=nav-icons-divider></span><div class="nav-link dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target">theme</span>
<a aria-hidden=true role=switch><span class=theme-toggle-icon data-feather=moon></span></a></div><div class=nav-link id=hamburger-menu-toggle><span class="sr-only hamburger-menu-toggle-screen-reader-target">menu</span>
<a aria-checked=false aria-labelledby=hamburger-menu-toggle id=hamburger-menu-toggle-target role=switch><span data-feather=menu></span></a></div><ul class="nav-hamburger-list visibility-hidden"><li class=nav-item><a href=http://localhost:1313/><span data-feather=home></span> Home</a></li><li class=nav-item><a href=http://localhost:1313/posts/><span data-feather=book></span> Posts</a></li><li class=nav-item><a href=http://localhost:1313/projects/><span data-feather=code></span> Projects</a></li><li class=nav-item><a href=http://localhost:1313/tags/><span data-feather=tag></span> Tags</a></li><li class=nav-item><a href=http://localhost:1313/tips/><span data-feather=info></span> Tips</a></li><li class=nav-item><a href=https://github.com/dgv><span data-feather=github></span></a></li><li class=nav-item><a href=http://localhost:1313/index.xml><span data-feather=rss></span></a></li><li class="nav-item dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target">theme</span>
<a role=switch><span class=theme-toggle-icon data-feather=moon></span></a></li></ul></div></nav></header><main id=content><div class="post container"><div class=post-header-section><h1>sqlite over s3</h1><small role=doc-subtitle></small><p class=post-date>November 10, 2024</p><ul class=post-tags></ul></div><div class=post-content><p>We love <a href=https://mcfunley.com/choose-boring-technology>boring technology</a>, sqlite is everywere, solid stunning performace and features,
but it was developed to be embeded to the app without a management system, developers love this simplicity so for years people and
companies are trying to develop solutions to distribute sqlite and make the stored data broadly available, lately:</p><ul><li>you can run your sqlite cluster over <a href=https://www.sqlite.org/wal.html>wal</a>/<a href=https://raft.github.io/>raft</a> with <a href=https://rqlite.io/>rqlite</a></li><li>fly has <a href=https://fly.io/docs/litefs/>LiteFS</a></li><li>cloudflare has <a href=https://developers.cloudflare.com/d1/>D1</a></li><li>turso and <a href=https://docs.turso.tech/libsql>libSQL</a></li></ul><p>Recently during the rewrite of my <a href=https://github.com/dgv/play.zig>Zig playground</a> project I decided to move the snipets from Google Datastore to Sqlite, but I don&rsquo;t want to manage any
cloud-serveless-uber-solution crazy pricing, even with free quota. I tried turso, liked the idea of <a href=https://turso.tech/blog/introducing-embedded-replicas-deploy-turso-anywhere-2085aa0dc242>embeded replicas</a>,
but had problems testing on free-tier, imagine you&rsquo;re testing your app with initial data then everything is gone for no reason, well later they report the <a href=https://turso.tech/blog/incident-2023-12-04-data-leak-and-loss-in-some-free-tier-databases-7cba5bc7>incident</a>.
Just want something simple, don&rsquo;t want to manage a cluster or be depedent of a provider implementation in particular.</p><p>What is cheaper and simpler than managed databases and all this serveless stuff? Storage, fortunetly these days most providers are compatible with <a href=https://docs.aws.amazon.com/AmazonS3/latest/API/Type_API_Reference.html>S3 API</a>.</p><h3 id=aws-and-s3-compatible-providers>aws and s3-compatible providers</h3><table><thead><tr><th>Cloud Provider</th><th>1 TB stored<br>250 GB reads<br>100 GB writes</th><th>Free-tier</th></tr></thead><tbody><tr><td>Hetzner</td><td>$5.41 / mo</td><td></td></tr><tr><td>Backblaze</td><td>$6.00 / mo</td><td></td></tr><tr><td>Vultr</td><td>$6.00 / mo</td><td></td></tr><tr><td>Contabo</td><td>$10.78 / mo</td><td>5GB</td></tr><tr><td>Civo</td><td>$10.00 / mo</td><td></td></tr><tr><td>OVHcloud</td><td>$10.75 / mo</td><td></td></tr><tr><td>Scaleway</td><td>$15.70 / mo</td><td></td></tr><tr><td>Entrywan</td><td>$17.50 / mo</td><td></td></tr><tr><td>Nebius</td><td>$18.80 / mo</td><td></td></tr><tr><td>Exoscale</td><td>$19.80 / mo</td><td></td></tr><tr><td>Cloudflare</td><td>$19.86 / mo</td><td>10GB</td></tr><tr><td>DigitalOcean</td><td>$20.00 / mo</td><td></td></tr><tr><td>Linode</td><td>$20.00 / mo</td><td></td></tr><tr><td>Sevalla</td><td>$20.00 / mo</td><td></td></tr><tr><td>UpCloud</td><td>$21.65 / mo</td><td></td></tr><tr><td>Fly.io / Tigris</td><td>$21.00 / mo</td><td>5GB</td></tr><tr><td>Microsoft Azure</td><td>$21.50 / mo</td><td></td></tr><tr><td>Amazon Web Services</td><td>$24.63 / mo</td><td>5GB</td></tr><tr><td>Google Cloud</td><td>$24.93 / mo</td><td></td></tr><tr><td>Bunny CDN</td><td>$25.00 / mo</td><td></td></tr><tr><td>Oracle Cloud</td><td>$25.57 / mo</td><td></td></tr><tr><td>Alibaba Cloud</td><td>$43.84 / mo</td><td></td></tr></tbody></table><p><a href=https://getdeploying.com/reference/object-storage>check updated list</a> or run yourself using <a href=https://github.com/minio/minio>minio</a></p><p>So, instead of use turso sqlite fork to sync or another alternative using WAL, what about add an abstraction to write directly thru S3 API using sqlite? Fortunetly someone already did that using extensions.</p><h2 id=s3db>s3db</h2><p>As I said the best approach is to use <a href=https://www.sqlite.org/loadext.html>extensions</a> (if you&rsquo;re macos user check if your sqlite support is enabled or use <a href=https://github.com/dgv/s3db/blob/b6ce6fc9d9ea680b2db879d68d70dfaf3642faa2/sqlite/sqlite-autoload-extension/auto_darwin.go#L5-L6>brew version</a>), as linked library to sqlite is independent of which languange you&rsquo;re using, you just need to <a href=https://www.sqlite.org/c3ref/auto_extension.html>load</a> it from the driver you&rsquo;re using, s3db uses <a href=https://www.sqlite.org/vtab.html>virtual tables</a> to abstract and store the data on S3 buckets, so you can also mix with real ones if you wish.
The project from Jeff Rhyason seems stable, he is maintaining it for more than year, I read the entire source relatively quikly, the inital documentation at readme cover all the important aspects, but one thing grab my attention&mldr;</p><p><em><strong>Multiple Writers</strong></em></p><p><em>Multiple writers can commit modifications from the same version. The next reader will automatically merge both new versions. <strong>If there are any conflicting rows, the winner is chosen by &ldquo;last write wins&rdquo;, on a per-column basis.</strong> Additionally, for any row, a DELETE supersedes all UPDATEs with a later row modification time, until another INSERT for the same key. In order to facilitate this, deletions consume space until vacuumed.</em></p><p><em><strong>Each writer can set its write_time corresponding to the ideal time that the column values are to be affected, which can be useful for idempotence</strong>. For example, write_time could rewind to the original request time to avoid undoing later updates in retries.</em></p><p>Liked it because is easier to understand the entire thing, even not knowing all S3/sqlite particularities, it already have a cache (<em>node_cache_entries</em>) and vacum (<em>s3db_vacuum</em>) mechanism over the buckets.</p><h2 id=how-slow-it-is>how slow it is?</h2><p>Looks nice, but what about the overhead added by the abstraction and the latency involved to send data to S3 in each transaction? Another important consideration is about which type of S3 service you are using,
some providers have optimized IOPS using NVMes, replication etc, let&rsquo;s test using the best free-tier scenario to start:</p><ul><li>Fly.io free-quota: shared-cpu-1x 256mb at IAD (Ashburn, Virginia)</li><li>Tigris free-quota: 5GB at IAD (Ashburn, Virginia)</li></ul><p>I&rsquo;ll use the most used Golang sqlite&rsquo;s driver from mattn and <a href>modified</a> version of a Golang drivers benchmark to store data on memory to measure the impact of abstraction (represented by mattn-mem and s3db-mem) and the latecy using the vm volume vs remote s3 bucket (represented by mattn-local and s3db-tigris).</p><p>Tigris is already hosted on Fly.io so the latency to reach them is pretty low (around ~2ms), the results below are in miliseconds, lower is better.</p><h3 id=schema>schema</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=s2>&#34;PRAGMA journal_mode=DELETE&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=s2>&#34;PRAGMA synchronous=FULL&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=s2>&#34;PRAGMA foreign_keys=1&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=s2>&#34;PRAGMA busy_timeout=5000&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=s2>&#34;CREATE TABLE users (&#34;</span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=s2>&#34;id INTEGER PRIMARY KEY NOT NULL,&#34;</span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=s2>&#34; created INTEGER NOT NULL,&#34;</span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=s2>&#34; email TEXT NOT NULL,&#34;</span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=s2>&#34; active INTEGER NOT NULL)&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=s2>&#34;CREATE TABLE articles (&#34;</span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=s2>&#34;id INTEGER PRIMARY KEY NOT NULL,&#34;</span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=s2>&#34; created INTEGER NOT NULL, &#34;</span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=s2>&#34; userId INTEGER NOT NULL,&#34;</span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=s2>&#34; text TEXT NOT NULL)&#34;</span><span class=p>,</span><span class=o>=</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=s2>&#34;CREATE TABLE comments (&#34;</span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=s2>&#34;id INTEGER PRIMARY KEY NOT NULL,&#34;</span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=s2>&#34; created INTEGER NOT NULL, &#34;</span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=s2>&#34; articleId INTEGER NOT NULL,&#34;</span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=s2>&#34; text TEXT NOT NULL)&#34;</span><span class=p>,</span><span class=w>
</span></span></span></code></pre></div><h3 id=simple>simple</h3><h3 id=complex>complex</h3><h3 id=large>large</h3><p>limited to 200MB based on the available RAM.</p><h3 id=concurrency>concurrency</h3><p>1MM records (~56MB)</p><h2 id=conclusions>conclusions</h2><p>I&rsquo;m happy using s3db, even slow certainly will consider on other projects where performance is tolerated over simplicity or storage pricing.
Nowadays we have really great tooling for selfhost anything and we can easily use sqlite and distribute it, now I can easily migrate
from any other compatible storage provider just changing env vars and migrating the bucket files using <a href=https://docs.aws.amazon.com/cli/latest/reference/s3/sync.html><em>aws s3 sync</em></a>.</p><h3 id=related-references>related references</h3><ul><li><a href=https://github.com/jrhy/s3db/blob/main/sqlite/Makefile>Compiling and running s3db on minio directly from sqlite</a></li><li><a href=https://github.com/jrhy/s3db/tree/main/example-go-app>Golang s3db sample app</a></li><li><a href=https://github.com/dgv/s3db.zig/>My zig wrapper around s3db</a></li><li><a href="https://www.youtube.com/watch?v=PGpL5hYpY1o">SQLite and its weird new fork “libSQL”</a></li><li><a href=https://sqlite.org/draft/howtocorrupt.html>How To Corrupt An SQLite Database File</a></li><li><a href=https://sqlite.org/rsync.html>Database Remote-Copy Tool For SQLite</a></li></ul></div><div class=prev-next></div><svg id="btt-button" class="arrow-logo" height="1em" viewBox="0 0 384 512" onclick="scrollToTop()" title="Go to top"><path d="M177 159.7l136 136c9.4 9.4 9.4 24.6.0 33.9l-22.6 22.6c-9.4 9.4-24.6 9.4-33.9.0L160 255.9l-96.4 96.4c-9.4 9.4-24.6 9.4-33.9.0L7 329.7c-9.4-9.4-9.4-24.6.0-33.9l136-136c9.4-9.5 24.6-9.5 34-.1z"/></svg>
<script>let backToTopButton=document.getElementById("btt-button");window.onscroll=function(){scrollFunction()};function scrollFunction(){document.body.scrollTop>20||document.documentElement.scrollTop>20?backToTopButton.style.display="block":backToTopButton.style.display="none"}function scrollToTop(){window.scrollTo(0,0)}</script></div><aside class=post-toc><nav id=toc><nav id=TableOfContents><ul><li><ul><li><ul><li><a href=#aws-and-s3-compatible-providers>aws and s3-compatible providers</a></li></ul></li><li><a href=#s3db>s3db</a></li><li><a href=#how-slow-it-is>how slow it is?</a><ul><li><a href=#schema>schema</a></li><li><a href=#simple>simple</a></li><li><a href=#complex>complex</a></li><li><a href=#large>large</a></li><li><a href=#concurrency>concurrency</a></li></ul></li><li><a href=#conclusions>conclusions</a><ul><li><a href=#related-references>related references</a></li></ul></li></ul></li></ul></nav></nav></aside></main><footer class=footer><span>Made with &#10084;&#65039; using <a target=_blank href=https://github.com/gokarna-theme/gokarna-hugo>Gokarna</a></span></footer></body></html>